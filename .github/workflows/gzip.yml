name: Gzip All Files and Release

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  compress-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup zip & gzip utilities
        run: sudo apt-get update && sudo apt-get install -y gzip zip

      - name: Prepare gzipped files
        run: |
          mkdir -p gzipped
          # Compress each file in the repo (skip .git and workflow files)
          find . -type f ! -path "./.git/*" ! -path "./.github/*" | while read f; do
            base=$(basename "$f")
            gzip -c "$f" > "gzipped/$base.gz"
          done
          echo "All files gzipped into the gzipped/ folder"

      - name: Create zip of gzipped files
        run: |
          ZIP_NAME="gzipped_files_$(date +'%Y%m%d_%H%M%S').zip"
          cd gzipped
          zip -r "../$ZIP_NAME" .
          cd ..
          echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_ENV
          TAG_NAME="gzipped-$(date +'%Y%m%d-%H%M%S')"
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV
          echo "Created zip $ZIP_NAME with tag $TAG_NAME"

      - name: Create GitHub Release
        id: release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ env.TAG_NAME }}
          name: "Gzipped Files ${{ env.TAG_NAME }}"
          draft: false
          prerelease: false
          skipIfReleaseExists: true

      - name: Upload zip to release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ env.TAG_NAME }}
          artifacts: ${{ env.ZIP_NAME }}
