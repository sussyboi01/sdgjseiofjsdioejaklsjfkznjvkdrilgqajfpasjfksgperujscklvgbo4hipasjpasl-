name: Find Similar File Names

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  find-similar:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Explicitly allow the action to write to the repo

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch all history to ensure merge/rebase works smoothly

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Run script to find similar files
        run: |
          node << 'EOF'
          const fs = require("fs");
          const path = require("path");

          const scanDir = process.cwd(); 

          // Recursive file getter
          function getAllFiles(dir) {
            let results = [];
            if (dir.includes('.git')) return results;

            try {
              fs.readdirSync(dir, { withFileTypes: true }).forEach(file => {
                const fullPath = path.join(dir, file.name);
                if (file.isDirectory()) {
                  results = results.concat(getAllFiles(fullPath));
                } else {
                  results.push(fullPath);
                }
              });
            } catch (e) { }
            return results;
          }

          const allFiles = getAllFiles(scanDir);
          
          // Get filenames without extension
          const fileNames = allFiles.map(f => path.basename(f, path.extname(f)));

          // Normalize: Lowercase, remove 'cl' prefix, remove symbols
          function normalize(name) {
            let n = name.toLowerCase();
            
            // Remove 'cl' ONLY if it is at the start
            n = n.replace(/^cl/, ''); 

            // Remove non-alphanumeric characters
            return n.replace(/[^a-z0-9]/g, "");
          }

          const normalizedMap = {};
          fileNames.forEach(name => {
            const norm = normalize(name);
            if (!norm) return; 

            if (!normalizedMap[norm]) {
              normalizedMap[norm] = [];
            }
            normalizedMap[norm].push(name);
          });

          // Filter groups
          const similarGroups = Object.values(normalizedMap)
            .filter(group => group.length > 1)
            .filter(group => {
               const uniqueNames = new Set(group);
               return uniqueNames.size > 1 || group.length > 1; 
            });

          const outputPath = path.join(process.cwd(), "similar-names.json");
          fs.writeFileSync(outputPath, JSON.stringify(similarGroups, null, 2));

          console.log(`Found ${similarGroups.length} groups of similar names.`);
          EOF

      - name: Commit and push similar-names.json
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          
          git add similar-names.json
          
          # Check if there are changes before committing
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update similar-names.json"
            
            # --- THE FIX ---
            # Pull the latest changes from the remote repo to avoid 'fetch first' error
            # --rebase applies your new commit on top of the remote changes
            git pull --rebase origin main
            
            git push origin main
          fi
