name: Find Similar File Names

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  find-similar:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Run script to find similar files
        run: |
          node << 'EOF'
          const fs = require("fs");
          const path = require("path");

          // Folder to scan (change if needed)
          const scanDir = process.cwd(); 

          // Get all files (recursive)
          function getAllFiles(dir) {
            let results = [];
            fs.readdirSync(dir, { withFileTypes: true }).forEach(file => {
              const fullPath = path.join(dir, file.name);
              if (file.isDirectory()) {
                results = results.concat(getAllFiles(fullPath));
              } else {
                results.push(fullPath);
              }
            });
            return results;
          }

          const allFiles = getAllFiles(scanDir);

          // Extract just the filename without extension
          const fileNames = allFiles.map(f => path.basename(f, path.extname(f)));

          // Normalize: lowercase, remove non-alphanumeric
          function normalize(name) {
            return name.toLowerCase().replace(/[^a-z0-9]/g, "");
          }

          const normalizedMap = {};
          fileNames.forEach(name => {
            const norm = normalize(name);
            if (!normalizedMap[norm]) {
              normalizedMap[norm] = [];
            }
            normalizedMap[norm].push(name);
          });

          // Only groups with more than 1 similar file
          const similarGroups = Object.values(normalizedMap).filter(group => group.length > 1);

          // Save JSON
          const outputPath = path.join(process.cwd(), "similar-names.json");
          fs.writeFileSync(outputPath, JSON.stringify(similarGroups, null, 2));

          console.log(`Found ${similarGroups.length} groups of similar names.`);
          EOF

      - name: Commit and push similar-names.json
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          git add similar-names.json
          git commit -m "Update similar-names.json" || echo "No changes to commit"
          git push
