name: Find Similar File Names

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  find-similar:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Run script to find similar files
        run: |
          node << 'EOF'
          const fs = require("fs");
          const path = require("path");

          const scanDir = process.cwd(); 

          // Recursive file getter
          function getAllFiles(dir) {
            let results = [];
            // Skip .git to avoid scanning internal git objects
            if (dir.includes('.git')) return results;

            try {
              fs.readdirSync(dir, { withFileTypes: true }).forEach(file => {
                const fullPath = path.join(dir, file.name);
                if (file.isDirectory()) {
                  results = results.concat(getAllFiles(fullPath));
                } else {
                  results.push(fullPath);
                }
              });
            } catch (e) {
              // Ignore access errors
            }
            return results;
          }

          const allFiles = getAllFiles(scanDir);
          
          // Get filenames without extension
          const fileNames = allFiles.map(f => path.basename(f, path.extname(f)));

          // Normalize: 
          // 1. Lowercase 
          // 2. Remove 'cl' from the start (case-insensitive)
          // 3. Remove non-alphanumeric characters
          function normalize(name) {
            let n = name.toLowerCase();
            
            // Remove 'cl' prefix if present (e.g., 'clButton' -> 'button')
            n = n.replace(/^cl/, ''); 

            // Remove non-alphanumeric (e.g., 'button-primary' -> 'buttonprimary')
            return n.replace(/[^a-z0-9]/g, "");
          }

          const normalizedMap = {};
          fileNames.forEach(name => {
            const norm = normalize(name);
            if (!norm) return; 

            if (!normalizedMap[norm]) {
              normalizedMap[norm] = [];
            }
            normalizedMap[norm].push(name);
          });

          // Only keep groups where:
          // 1. There is more than 1 file
          // 2. The names are not exactly the same (ignoring duplicates if file exists in multiple folders)
          const similarGroups = Object.values(normalizedMap)
            .filter(group => group.length > 1)
            // Optional: Filter out groups where all original names are identical 
            // (e.g. folderA/test.js and folderB/test.js) if you only want 'similar' but different names
            .filter(group => {
               const uniqueNames = new Set(group);
               return uniqueNames.size > 1 || group.length > 1; 
            });

          const outputPath = path.join(process.cwd(), "similar-names.json");
          fs.writeFileSync(outputPath, JSON.stringify(similarGroups, null, 2));

          console.log(`Found ${similarGroups.length} groups of similar names.`);
          EOF

      - name: Commit and push similar-names.json
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          git add similar-names.json
          git diff --staged --quiet || git commit -m "Update similar-names.json"
          git push
